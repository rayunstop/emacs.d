cscope 15 $HOME/Source/taobao/CS/server_platform/branches/modules-devel/mod_tmd/tmd_http_module               0000032966
	@ngx_http_tmd_module.c

1 
	~<ngx_c‹e.h
>

2 
	~<ngx_c⁄fig.h
>

3 
	~<ngx_hâp.h
>

4 
	~<ngx_ch™√l.h
>

5 
	~<ngx_tmd_ch™√l.h
>

6 
	~<ngx_tmd_shm.h
>

9 
	#NGX_HTTP_TMD_MAX_RESOURCE
 254

	)

13 
ngx_¶ab_poﬁ_t
 *
	mshpoﬁ
;

14 
ngx_tmd_shm_˘x_t
 *
	msh
;

15 
ngx_c⁄√˘i⁄_t
 *
	mc⁄√˘i⁄
;

16 } 
	tngx_hâp_tmd_˘x_t
;

20 
ngx_Êag_t
 
	míabÀ
;

21 
ngx_shm_z⁄e_t
 *
	mshm_z⁄e
;

22 
ngx_hâp_tmd_˘x_t
 *
	mtmd_˘x
;

23 } 
	tngx_hâp_tmd_maö_c⁄f_t
;

28 
ngx_Êag_t
 
	míabÀ
;

30 
ngx_uöt_t
 
	mtmd_log_Àvñ
;

32 
ngx_°r_t
 
	m˛õ¡_ù_hódî
;

34 
ngx_°r_t
 
	mcc_a˘i⁄
;

35 
ngx_°r_t
 
	mpunish_a˘i⁄
;

36 
ngx_°r_t
 
	mtc_a˘i⁄
;

38 
ngx_°r_t
 
	mgeo_v¨_«me
;

39 
ngx_öt_t
 
	mgeo_v¨_ödex
;

40 
ngx_°r_t
 
	mgeo_v¨_vÆue
;

41 
ngx_°r_t
 
	mgeo_ù_«me
;

43 } 
	tngx_hâp_tmd_loc_c⁄f_t
;

47 
ngx_°r_t
 
	maddr_ãxt
;

48 
ngx_ö_cidr_t
 
	mcidr
;

49 
ngx_öt_t
 
	mtc_waô_time
;

50 } 
	tngx_hâp_tmd_ªq_˘x_t
;

53 
ngx_öt_t
 
ngx_hâp_tmd_öô
(
ngx_c⁄f_t
 *
cf
);

54 *
ngx_hâp_tmd_¸óã_maö_c⁄f
(
ngx_c⁄f_t
 *
cf
);

55 *
ngx_hâp_tmd_öô_maö_c⁄f
(
ngx_c⁄f_t
 *
cf
, *
c⁄f
);

56 *
ngx_hâp_tmd_¸óã_loc_c⁄f
(
ngx_c⁄f_t
 *
cf
);

57 *
ngx_hâp_tmd_mîge_c⁄f
(
ngx_c⁄f_t
 *
cf
, *
∑ª¡
, *
chûd
);

58 
ngx_öt_t
 
ngx_hâp_tmd_check_íabÀ
(
ngx_hâp_ªque°_t
 *
r
);

59 
ngx_öt_t
 
ngx_hâp_tmd_h™dÀr
(
ngx_hâp_ªque°_t
 *
r
);

60 
ngx_öt_t
 
ngx_hâp_tmd_c⁄åﬁ_h™dÀr
(
ngx_hâp_ªque°_t
 *
r
);

61 
ngx_öt_t
 
ngx_hâp_tmd_öô_¥o˚ss
(
ngx_cy˛e_t
 *
cy˛e
);

62 
ngx_hâp_tmd_ªad_h™dÀr
(
ngx_evít_t
 *
ªv
);

63 *
ngx_hâp_tmd_£t_shm
(
ngx_c⁄f_t
 *
cf
,

64 
ngx_comm™d_t
 *
cmd
, *
c⁄f
);

65 
ngx_öt_t
 
ngx_hâp_tmd_öô_shm_z⁄e
(
ngx_hâp_tmd_˘x_t
 *
t˘x
);

66 
ngx_hâp_tmd_exô_¥o˚ss
(
ngx_cy˛e_t
 *
cy˛e
);

67 
ngx_öt_t
 
ngx_hâp_tmd_dod
(
ngx_hâp_ªque°_t
 *
r
,Çgx_öt_à
mode
);

68 
ngx_öt_t
 
ngx_hâp_tmd_∑r£_hódîö
(
ngx_hâp_ªque°_t
 *
r
,

69 
ngx_°r_t
 *
hódî_«me
,Çgx_°r_à*
vÆue
);

70 
ngx_öt_t
 
ngx_hâp_tmd_ù_punish
(
ngx_hâp_ªque°_t
 *
r
,

71 
ngx_uöt_t
 *
mósuª
);

72 
ngx_ölöe
 
ngx_öt_t
 
ngx_hâp_tmd_ªmŸe_addr
(
ngx_hâp_ªque°_t
 *
r
,

73 
ngx_°r_t
 *
ªmŸe_addr
, 
ngx_öt_t
 
mode
);

74 
ngx_öt_t
 
ngx_hâp_tmd_cidr_vÆue
(
ngx_°r_t
 *
ù
, 
ngx_cidr_t
 *
cidr
,

75 
ngx_log_t
 *
log
);

76 
ngx_öt_t
 
ngx_hâp_tmdagít_ªque°
(
ngx_hâp_ªque°_t
 *
r
,

77 
ngx_°r_t
 **
cookõs
, 
uöt16_t
 
cookõ_Àn
, 
ngx_öt_t
 
mósuª
,

78 
ngx_°r_t
 *
ªmŸe_addr
);

79 
uöt16_t
 
ngx_hâp_tmd_comböe_cookõ
(
ngx_hâp_ªque°_t
 *
r
,

80 
ngx_°r_t
 **
cookõs
, 
ngx_uöt_t
 *
mósuª
);

81 
ölöe
 
ngx_öt_t
 
ngx_hâp_tmd_¥o˚ss_a˘i⁄
(
ngx_hâp_ªque°_t
 *
r
,

82 
ngx_hâp_tmd_loc_c⁄f_t
 *
écf
, 
ngx_°r_t
 *
a˘i⁄
);

83 * 
ngx_hâp_tmd_c⁄åﬁ
(
ngx_c⁄f_t
 *
cf
, 
ngx_comm™d_t
 *
cmd
,

84 *
c⁄f
);

85 
ngx_öt_t
 
ngx_hâp_tmd_hourgœss_v¨übÀ
(
ngx_hâp_ªque°_t
 *
r
,

86 
ngx_hâp_v¨übÀ_vÆue_t
 *
v
, 
uöçå_t
 
d©a
);

87 
ngx_öt_t
 
ngx_hâp_tmd_ôﬂ
“gx_öt_à
vÆue
,

88 
ngx_uöt_t
 
max
, 
u_ch¨
 *
°r
);

89 
ngx_öt_t
 
ngx_hâp_tmd_check_°©ic_whôñi°
(
ngx_hâp_ªque°_t
 *
r
,

90 
ngx_hâp_tmd_loc_c⁄f_t
 *
c⁄f
);

91 *
ngx_hâp_tmd_£t_geo_v¨_ödex
(
ngx_c⁄f_t
 *
cf
,

92 
ngx_comm™d_t
 *
cmd
, *
c⁄f
);

93 *
ngx_hâp_tmd_£t_geo_ù_«me
(
ngx_c⁄f_t
 *
cf
,

94 
ngx_comm™d_t
 *
cmd
, *
c⁄f
);

95 
ngx_öt_t
 
ngx_hâp_tmd_geo_ù_v¨übÀ
(
ngx_hâp_ªque°_t
 *
r
,

96 
ngx_hâp_v¨übÀ_vÆue_t
 *
v
, 
uöçå_t
 
d©a
);

97 
ngx_öt_t
 
ngx_hâp_tmd_check_ac˚ss_∑ges
(
ngx_hâp_ªque°_t
 *
r
);

100 
ngx_c⁄f_íum_t
 
	gngx_hâp_tmd_log_Àvñs
[] = {

101 { 
ngx_°rög
("öfo"), 
NGX_LOG_INFO
 },

102 { 
ngx_°rög
("nŸi˚"), 
NGX_LOG_NOTICE
 },

103 { 
ngx_°rög
("w¨n"), 
NGX_LOG_WARN
 },

104 { 
ngx_°rög
("îr‹"), 
NGX_LOG_ERR
 },

105 { 
ngx_nuŒ_°rög
, 0 }

109 
ngx_comm™d_t
 
	gngx_hâp_tmd_comm™ds
[] = {

111 { 
ngx_°rög
("tmd"),

112 
NGX_HTTP_MAIN_CONF
|
NGX_CONF_FLAG
,

113 
ngx_c⁄f_£t_Êag_¶Ÿ
,

114 
NGX_HTTP_MAIN_CONF_OFFSET
,

115 
off£tof
(
ngx_hâp_tmd_maö_c⁄f_t
, 
íabÀ
),

116 
NULL
 },

118 { 
ngx_°rög
("tmd_shm"),

119 
NGX_HTTP_MAIN_CONF
|
NGX_CONF_TAKE3
,

120 
ngx_hâp_tmd_£t_shm
,

121 
NGX_HTTP_MAIN_CONF_OFFSET
,

123 
NULL
 },

125 { 
ngx_°rög
("tmd_preaccess"),

126 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_FLAG
,

127 
ngx_c⁄f_£t_Êag_¶Ÿ
,

128 
NGX_HTTP_LOC_CONF_OFFSET
,

129 
off£tof
(
ngx_hâp_tmd_loc_c⁄f_t
, 
íabÀ
),

130 
NULL
 },

132 { 
ngx_°rög
("tmd_control"),

133 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF


134 |
NGX_CONF_TAKE2
|
NGX_CONF_TAKE3
|
NGX_CONF_TAKE4
,

135 
ngx_hâp_tmd_c⁄åﬁ
,

136 
NGX_HTTP_LOC_CONF_OFFSET
,

138 
NULL
 },

140 { 
ngx_°rög
("tmd_geo_var_name"),

141 
NGX_HTTP_LOC_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_MAIN_CONF
|
NGX_CONF_TAKE1
,

142 
ngx_hâp_tmd_£t_geo_v¨_ödex
,

143 
NGX_HTTP_LOC_CONF_OFFSET
,

144 
off£tof
(
ngx_hâp_tmd_loc_c⁄f_t
, 
geo_v¨_«me
),

145 
NULL
 },

147 { 
ngx_°rög
("tmd_geo_var_value"),

148 
NGX_HTTP_LOC_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_MAIN_CONF
|
NGX_CONF_TAKE1
,

149 
ngx_c⁄f_£t_°r_¶Ÿ
,

150 
NGX_HTTP_LOC_CONF_OFFSET
,

151 
off£tof
(
ngx_hâp_tmd_loc_c⁄f_t
, 
geo_v¨_vÆue
),

152 
NULL
 },

154 { 
ngx_°rög
("tmd_geo_ip_name"),

155 
NGX_HTTP_LOC_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_MAIN_CONF
|
NGX_CONF_TAKE1
,

156 
ngx_hâp_tmd_£t_geo_ù_«me
,

157 
NGX_HTTP_LOC_CONF_OFFSET
,

158 
off£tof
(
ngx_hâp_tmd_loc_c⁄f_t
, 
geo_ù_«me
),

159 
NULL
 },

161 { 
ngx_°rög
("tmd_log_level"),

162 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

163 
ngx_c⁄f_£t_íum_¶Ÿ
,

164 
NGX_HTTP_LOC_CONF_OFFSET
,

165 
off£tof
(
ngx_hâp_tmd_loc_c⁄f_t
, 
tmd_log_Àvñ
),

166 &
ngx_hâp_tmd_log_Àvñs
 },

168 
ngx_nuŒ_comm™d


172 
ngx_hâp_moduÀ_t
 
	gngx_hâp_tmd_moduÀ_˘x
 = {

173 
NULL
,

174 
ngx_hâp_tmd_öô
,

176 
ngx_hâp_tmd_¸óã_maö_c⁄f
,

177 
ngx_hâp_tmd_öô_maö_c⁄f
,

179 
NULL
,

180 
NULL
,

182 
ngx_hâp_tmd_¸óã_loc_c⁄f
,

183 
ngx_hâp_tmd_mîge_c⁄f


187 
ngx_moduÀ_t
 
	gngx_hâp_tmd_moduÀ
 = {

188 
NGX_MODULE_V1
,

189 &
ngx_hâp_tmd_moduÀ_˘x
,

190 
ngx_hâp_tmd_comm™ds
,

191 
NGX_HTTP_MODULE
,

192 
NULL
,

193 
NULL
,

194 
ngx_hâp_tmd_öô_¥o˚ss
,

195 
NULL
,

196 
NULL
,

197 
ngx_hâp_tmd_exô_¥o˚ss
,

198 
NULL
,

199 
NGX_MODULE_V1_PADDING


203 
ngx_sockë_t
 
ngx_tmd_sockë∑ús
[
NGX_MAX_PROCESSES
][2];

206 
ngx_öt_t


207 
	$ngx_hâp_tmd_öô
(
ngx_c⁄f_t
 *
cf
)

209 
ngx_hâp_h™dÀr_±
 *
h
;

210 
ngx_hâp_c‹e_maö_c⁄f_t
 *
cmcf
;

212 
cmcf
 = 
	`ngx_hâp_c⁄f_gë_moduÀ_maö_c⁄f
(
cf
, 
ngx_hâp_c‹e_moduÀ
);

214 
h
 = 
	`ngx_¨øy_push
(&
cmcf
->
pha£s
[
NGX_HTTP_PREACCESS_PHASE
].
h™dÀrs
);

216 i‡(
h
 =
NULL
) {

217  
NGX_ERROR
;

220 *
h
 = 
ngx_hâp_tmd_h™dÀr
;

222 
h
 = 
	`ngx_¨øy_push
(&
cmcf
->
pha£s
[
NGX_HTTP_ACCESS_PHASE
].
h™dÀrs
);

224 i‡(
h
 =
NULL
) {

225  
NGX_ERROR
;

228 *
h
 = 
ngx_hâp_tmd_c⁄åﬁ_h™dÀr
;

230  
NGX_OK
;

231 
	}
}

235 
	$ngx_hâp_tmd_öô_maö_c⁄f
(
ngx_c⁄f_t
 *
cf
, *
c⁄f
)

237 
ngx_hâp_tmd_maö_c⁄f_t
 *
tmcf
;

239 
tmcf
 = 
c⁄f
;

241 i‡(
tmcf
->
shm_z⁄e
 =
NGX_CONF_UNSET_PTR
) {

243 
	`ngx_c⁄f_log_îr‹
(
NGX_LOG_EMERG
, 
cf
, 0, "tmdÇeed set \"tmd_shm\".");

245  
NGX_CONF_ERROR
;

248  
NGX_CONF_OK
;

249 
	}
}

253 
	$ngx_hâp_tmd_¸óã_maö_c⁄f
(
ngx_c⁄f_t
 *
cf
)

255 
ngx_hâp_tmd_maö_c⁄f_t
 *
tmcf
;

257 
tmcf
 = 
	`ngx_pˇŒoc
(
cf
->
poﬁ
, (
ngx_hâp_tmd_maö_c⁄f_t
));

259 i‡(
tmcf
 =
NULL
) {

260  
NULL
;

263 
tmcf
->
íabÀ
 = 
NGX_CONF_UNSET
;

264 
tmcf
->
shm_z⁄e
 = 
NGX_CONF_UNSET_PTR
;

266  
tmcf
;

267 
	}
}

271 
	$ngx_hâp_tmd_¸óã_loc_c⁄f
(
ngx_c⁄f_t
 *
cf
)

273 
ngx_hâp_tmd_loc_c⁄f_t
 *
écf
;

275 
écf
 = 
	`ngx_pˇŒoc
(
cf
->
poﬁ
, (
ngx_hâp_tmd_loc_c⁄f_t
));

277 i‡(
écf
 =
NULL
) {

278  
NULL
;

281 
écf
->
íabÀ
 = 
NGX_CONF_UNSET
;

283 
écf
->
tmd_log_Àvñ
 = 
NGX_CONF_UNSET_UINT
;

285  
écf
;

286 
	}
}

289 
ngx_öt_t


290 
	$ngx_hâp_tmd_check_°©ic_whôñi°
(
ngx_hâp_ªque°_t
 *
r
,

291 
ngx_hâp_tmd_loc_c⁄f_t
 *
c⁄f
)

293 
ngx_hâp_v¨übÀ_vÆue_t
 *
vv
;

295 i‡(
c⁄f
->
geo_v¨_ödex
 !
NGX_CONF_UNSET
) {

296 
vv
 = 
	`ngx_hâp_gë_ödexed_v¨übÀ
(
r
, 
c⁄f
->
geo_v¨_ödex
);

298 i‡(
vv
 =
NULL
 || vv->
nŸ_found
) {

299  
NGX_OK
;

302 i‡((
vv
->
Àn
 =
c⁄f
->
geo_v¨_vÆue
.len)

303 && (
	`ngx_memcmp
(
vv
->
d©a
, 
c⁄f
->
geo_v¨_vÆue
.d©a, vv->
Àn
)

306 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
r
->
c⁄√˘i⁄
->
log
, 0,

308  
NGX_DECLINED
;

312  
NGX_OK
;

313 
	}
}

317 
	$ngx_hâp_tmd_c⁄åﬁ
(
ngx_c⁄f_t
 *
cf
, 
ngx_comm™d_t
 *
cmd
,

318 *
c⁄f
)

320 
ngx_hâp_tmd_loc_c⁄f_t
 *
écf
 = 
c⁄f
;

322 
ngx_°r_t
 *
vÆue
, 
s
;

323 
ngx_uöt_t
 
i
;

324 
ngx_hâp_v¨übÀ_t
 *
v¨
;

326 
vÆue
 = 
cf
->
¨gs
->
ñts
;

327 
i
 = 1; i < 
cf
->
¨gs
->
√…s
; i++) {

328 i‡(
	`ngx_°∫cmp
(
vÆue
[
i
].
d©a
, "tc_action=", 10) == 0) {

330 
s
.
Àn
 = 
vÆue
[
i
].len - 10;

331 
s
.
d©a
 = 
vÆue
[
i
].data + 10;

333 
écf
->
tc_a˘i⁄
 = 
s
;

338 i‡(
	`ngx_°∫cmp
(
vÆue
[
i
].
d©a
, "cc_action=", 10) == 0) {

340 
s
.
Àn
 = 
vÆue
[
i
].len - 10;

341 
s
.
d©a
 = 
vÆue
[
i
].data + 10;

343 
écf
->
cc_a˘i⁄
 = 
s
;

348 i‡(
	`ngx_°∫cmp
(
vÆue
[
i
].
d©a
, "punish_action=", 14) == 0) {

350 
s
.
Àn
 = 
vÆue
[
i
].len - 14;

351 
s
.
d©a
 = 
vÆue
[
i
].data + 14;

353 
écf
->
punish_a˘i⁄
 = 
s
;

357 i‡(
vÆue
[
i
].
d©a
[0] == '$') {

358 
vÆue
[
i
].
Àn
--;

359 
vÆue
[
i
].
d©a
++;

361 
v¨
 = 
	`ngx_hâp_add_v¨übÀ
(
cf
, &
vÆue
[
i
], 0);

362 i‡(
v¨
 =
NULL
) {

363  
NGX_CONF_ERROR
;

366 
v¨
->
gë_h™dÀr
 = 
ngx_hâp_tmd_hourgœss_v¨übÀ
;

367 
v¨
->
d©a
 = 0;

372 
	`ngx_c⁄f_log_îr‹
(
NGX_LOG_EMERG
, 
cf
, 0,

373 "övÆidÖ¨amëî \"%V\"", &
vÆue
[
i
]);

374  
NGX_CONF_ERROR
;

377  
NGX_CONF_OK
;

378 
	}
}

382 
	$ngx_hâp_tmd_mîge_c⁄f
(
ngx_c⁄f_t
 *
cf
, *
∑ª¡
, *
chûd
)

384 
ngx_hâp_tmd_loc_c⁄f_t
 *
¥ev
 = 
∑ª¡
;

385 
ngx_hâp_tmd_loc_c⁄f_t
 *
c⁄f
 = 
chûd
;

387 
	`ngx_c⁄f_mîge_vÆue
(
c⁄f
->
íabÀ
, 
¥ev
->enable, 0);

388 
	`ngx_c⁄f_mîge_uöt_vÆue
(
c⁄f
->
tmd_log_Àvñ
, 
¥ev
->tmd_log_level,

389 
NGX_LOG_ERR
);

391 
	`ngx_c⁄f_mîge_°r_vÆue
(
c⁄f
->
˛õ¡_ù_hódî
, 
¥ev
->client_ip_header,

394 
	`ngx_c⁄f_mîge_°r_vÆue
(
c⁄f
->
cc_a˘i⁄
, 
¥ev
->cc_action, "");

395 
	`ngx_c⁄f_mîge_°r_vÆue
(
c⁄f
->
tc_a˘i⁄
, 
¥ev
->tc_action, "");

396 
	`ngx_c⁄f_mîge_°r_vÆue
(
c⁄f
->
punish_a˘i⁄
, 
¥ev
->punish_action, "");

398 
	`ngx_c⁄f_mîge_°r_vÆue
(
c⁄f
->
geo_v¨_«me
, 
¥ev
->geo_var_name, "");

399 
	`ngx_c⁄f_mîge_°r_vÆue
(
c⁄f
->
geo_v¨_vÆue
, 
¥ev
->geo_var_value, "1");

401  
NGX_CONF_OK
;

402 
	}
}

405 
ngx_öt_t


406 
	$ngx_hâp_tmd_check_íabÀ
(
ngx_hâp_ªque°_t
 *
r
)

408 
ngx_hâp_tmd_loc_c⁄f_t
 *
écf
;

409 
ngx_hâp_tmd_maö_c⁄f_t
 *
tmcf
;

411 
écf
 = 
	`ngx_hâp_gë_moduÀ_loc_c⁄f
(
r
, 
ngx_hâp_tmd_moduÀ
);

412 
tmcf
 = 
	`ngx_hâp_gë_moduÀ_maö_c⁄f
(
r
, 
ngx_hâp_tmd_moduÀ
);

414 i‡(!
écf
->
íabÀ
) {

415  
NGX_DECLINED
;

418 i‡(
r
->
maö
 !∏||Ñ->
öã∫Æ
) {

419  
NGX_DECLINED
;

422 i‡(
r
->
maö
->
limô_ªq_£t
) {

423  
NGX_DECLINED
;

426 
r
->
maö
->
limô_ªq_£t
 = 1;

428 i‡(
tmcf
->
tmd_˘x
->
sh
->
öô_°©e
 !
NGX_TMD_SHM_INIT_STATE_OK
) {

429  
NGX_DECLINED
;

432  
NGX_OK
;

433 
	}
}

436 
ölöe
 

437 
	$°ºevî£
(
u_ch¨
 *
begö
, u_ch¨ *
íd
)

439 
u_ch¨
 
aux
;

440 
íd
 > 
begö
) {

441 
aux
 = *
íd
;

442 *
íd
-- = *
begö
;

443 *
begö
++ = 
aux
;

445 
	}
}

448 
ngx_öt_t


449 
	$ngx_hâp_tmd_ôﬂ
(
ngx_öt_t
 
vÆue
, 
ngx_uöt_t
 
max
, 
u_ch¨
 *
°r
)

451 
ngx_uöt_t
 
uvÆue
;

452 
u_ch¨
 *
p
;

454 
p
 = 
°r
;

455 
uvÆue
 = (
vÆue
 < 0) ? -value : value;

458 *
p
++ = (
u_ch¨
Ë(48 + (
uvÆue
 % 10));

459 } (
uvÆue
 /10Ë> 0 && 
max
-- > 0);

461 i‡(
vÆue
 < 0) {

462 *
p
++ = '-';

465 
	`°ºevî£
(
°r
, 
p
 - 1);

466  
p
 - 
°r
;

467 
	}
}

470 
ngx_öt_t


471 
	$ngx_hâp_tmd_hourgœss_v¨übÀ
(
ngx_hâp_ªque°_t
 *
r
,

472 
ngx_hâp_v¨übÀ_vÆue_t
 *
v
, 
uöçå_t
 
d©a
)

474 
u_ch¨
 
waô_time_ãxt
[
NGX_TMD_SHM_MAX_WT_LEN
];

475 
ngx_öt_t
 
Àn
;

476 
ngx_hâp_tmd_ªq_˘x_t
 *
˘x
;

478 
˘x
 = 
	`ngx_hâp_gë_moduÀ_˘x
(
r
, 
ngx_hâp_tmd_moduÀ
);

480 i‡(
˘x
 =
NULL
) {

481  
NGX_ERROR
;

484 
	`ngx_log_îr‹
(
NGX_LOG_DEBUG
, 
r
->
c⁄√˘i⁄
->
log
, 0,

485 "tmd gë v¨ibñ i†%i", 
˘x
->
tc_waô_time
);

487 
Àn
 = 
	`ngx_hâp_tmd_ôﬂ
(
˘x
->
tc_waô_time
,

488 
NGX_TMD_SHM_MAX_WT_LEN
, 
waô_time_ãxt
);

490 
v
->
d©a
 = 
	`ngx_≤Æloc
(
r
->
poﬁ
, 
Àn
);

491 i‡(
v
->
d©a
 =
NULL
) {

492  
NGX_ERROR
;

495 
	`ngx_mem˝y
(
v
->
d©a
, 
waô_time_ãxt
, 
Àn
);

497 
v
->
Àn
 =Üen;

498 
v
->
vÆid
 = 1;

499 
v
->
no_ˇchóbÀ
 = 0;

500 
v
->
nŸ_found
 = 0;

502 
	`ngx_log_îr‹
(
NGX_LOG_DEBUG
, 
r
->
c⁄√˘i⁄
->
log
, 0,

503 "tmd gë v¨ibñ i†%i,%i", 
˘x
->
tc_waô_time
, 
Àn
);

504  
NGX_OK
;

505 
	}
}

509 
	$ngx_hâp_tmd_£t_geo_v¨_ödex
(
ngx_c⁄f_t
 *
cf
, 
ngx_comm™d_t
 *
cmd
, *
c⁄f
)

511 *
rc
;

512 
ngx_hâp_tmd_loc_c⁄f_t
 *
écf
 = 
c⁄f
;

514 i‡((
rc
 = 
	`ngx_c⁄f_£t_°r_¶Ÿ
(
cf
, 
cmd
, 
c⁄f
)Ë!
NGX_CONF_OK
) {

515  
rc
;

518 
écf
->
geo_v¨_ödex
 = 
	`ngx_hâp_gë_v¨übÀ_ödex
(
cf
, &écf->
geo_v¨_«me
);

520 i‡(
écf
->
geo_v¨_ödex
 =
NGX_ERROR
) {

521  
NGX_CONF_ERROR
;

524  
NGX_CONF_OK
;

525 
	}
}

529 
	$ngx_hâp_tmd_£t_geo_ù_«me
(
ngx_c⁄f_t
 *
cf
, 
ngx_comm™d_t
 *
cmd
, *
c⁄f
)

531 
ngx_hâp_tmd_loc_c⁄f_t
 *
écf
 = 
c⁄f
;

533 *
rc
;

534 
ngx_hâp_v¨übÀ_t
 *
v¨
;

536 i‡((
rc
 = 
	`ngx_c⁄f_£t_°r_¶Ÿ
(
cf
, 
cmd
, 
c⁄f
)Ë!
NGX_CONF_OK
) {

537  
rc
;

540 
v¨
 = 
	`ngx_hâp_add_v¨übÀ
(
cf
, &
écf
->
geo_ù_«me
, 0);

541 i‡(
v¨
 =
NULL
) {

542  
NGX_CONF_ERROR
;

545 
v¨
->
gë_h™dÀr
 = 
ngx_hâp_tmd_geo_ù_v¨übÀ
;

546 
v¨
->
d©a
 = 0;

547  
NGX_CONF_OK
;

548 
	}
}

551 
ngx_öt_t


552 
	$ngx_hâp_tmd_geo_ù_v¨übÀ
(
ngx_hâp_ªque°_t
 *
r
,

553 
ngx_hâp_v¨übÀ_vÆue_t
 *
v
, 
uöçå_t
 
d©a
)

555 
ngx_hâp_tmd_ªq_˘x_t
 *
˘x
;

557 
˘x
 = 
	`ngx_hâp_gë_moduÀ_˘x
(
r
, 
ngx_hâp_tmd_moduÀ
);

558 i‡(
˘x
 =
NULL
) {

559  
NGX_ERROR
;

562 
v
->
d©a
 = 
˘x
->
addr_ãxt
.data;

563 
v
->
Àn
 = 
˘x
->
addr_ãxt
.len;

564 
v
->
vÆid
 = 1;

565 
v
->
no_ˇchóbÀ
 = 0;

566 
v
->
nŸ_found
 = 0;

568 
	`ngx_log_îr‹
(
NGX_LOG_DEBUG
, 
r
->
c⁄√˘i⁄
->
log
, 0,

569 "tmd gë v¨ibñ i†%V", &
˘x
->
addr_ãxt
);

570  
NGX_OK
;

571 
	}
}

574 
ngx_öt_t


575 
	$ngx_hâp_tmd_h™dÀr
(
ngx_hâp_ªque°_t
 *
r
)

577 
ngx_hâp_tmd_maö_c⁄f_t
 *
tmcf
;

578 
ngx_hâp_tmd_loc_c⁄f_t
 *
écf
;

579 
ngx_hâp_tmd_˘x_t
 *
t˘x
;

580 
ngx_tmd_shm_˘x_t
 *
sh
;

581 
ngx_hâp_tmd_ªq_˘x_t
 *
˘x
;

582 
ngx_öt_t
 
mode
, 
rc
;

584 i‡(
	`ngx_hâp_tmd_check_íabÀ
(
r
Ë!
NGX_OK
) {

585  
NGX_DECLINED
;

588 
tmcf
 = 
	`ngx_hâp_gë_moduÀ_maö_c⁄f
(
r
, 
ngx_hâp_tmd_moduÀ
);

589 
écf
 = 
	`ngx_hâp_gë_moduÀ_loc_c⁄f
(
r
, 
ngx_hâp_tmd_moduÀ
);

590 
t˘x
 = 
tmcf
->
tmd_˘x
;

592 
sh
 = 
t˘x
->sh;

594 i‡(
sh
->
öô_°©e
 !
NGX_TMD_SHM_INIT_STATE_OK
) {

595 
	`ngx_log_îr‹
(
NGX_LOG_WARN
, 
r
->
c⁄√˘i⁄
->
log
, 0,

597  
NGX_DECLINED
;

600 
˘x
 = 
	`ngx_pˇŒoc
(
r
->
poﬁ
, (
ngx_hâp_tmd_ªq_˘x_t
));

602 i‡(
˘x
 =
NULL
) {

603  
NGX_ERROR
;

606 
	`ngx_hâp_£t_˘x
(
r
, 
˘x
, 
ngx_hâp_tmd_moduÀ
);

608 
mode
 = 
sh
->mode;

610 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
r
->
c⁄√˘i⁄
->
log
, 0,

611 "tmd dodá˘i⁄ i†%d", 
mode
);

613 i‡(
sh
->
tc_lo°_øtio
 =
NGX_TMD_SHM_TC_SYSTEM_BUSY
) {

614 
˘x
->
tc_waô_time
 = -1;

615 
	`ngx_log_îr‹
(
NGX_LOG_NOTICE
, 
r
->
c⁄√˘i⁄
->
log
, 0,

617  
	`ngx_hâp_tmd_¥o˚ss_a˘i⁄
(
r
, 
écf
, &—lcf->
tc_a˘i⁄
));

620 i‡(
mode
 & 
NGX_TMD_SHM_MOD_CCDEFENSE
) {

621 
	`¥ötf
("modê%d\n", 
mode
);

622 
rc
 = 
	`ngx_hâp_tmd_dod
(
r
, 
mode
);

624 i‡(
rc
 =
NGX_ERROR
) {

625 
	`ngx_log_îr‹
(
NGX_LOG_ERR
, 
r
->
c⁄√˘i⁄
->
log
, 0, "tmd dod failed");

626  
NGX_DONE
;

629 i‡(
rc
 =
NGX_DECLINED
) {

630  
NGX_DECLINED
;

635 i‡(
mode
 & 
NGX_TMD_SHM_MOD_PASS
) {

636  
NGX_DECLINED
;

639 
	`ngx_log_îr‹
(
écf
->
tmd_log_Àvñ
, 
r
->
c⁄√˘i⁄
->
log
, 0, "tmd handler "

640 "°¨à™dÖunish code: %ò%V", 
rc
, &
écf
->
punish_a˘i⁄
);

642 i‡(
mode
 & 
NGX_TMD_SHM_MOD_CHECKCODE
) {

643  
	`ngx_hâp_tmd_¥o˚ss_a˘i⁄
(
r
, 
écf
, &—lcf->
cc_a˘i⁄
));

646  
	`ngx_hâp_tmd_¥o˚ss_a˘i⁄
(
r
, 
écf
, &—lcf->
punish_a˘i⁄
));

649  
NGX_DECLINED
;

650 
	}
}

653 
ölöe
 
ngx_öt_t


654 
	$ngx_hâp_tmd_¥o˚ss_a˘i⁄
(
ngx_hâp_ªque°_t
 *
r
,

655 
ngx_hâp_tmd_loc_c⁄f_t
 *
écf
, 
ngx_°r_t
 *
a˘i⁄
)

658 i‡(
a˘i⁄
->
d©a
 =
NULL
) {

660  
NGX_DECLINED
;

662 } i‡(
a˘i⁄
->
d©a
[0] == '@') {

664 
	`ngx_log_îr‹
(
NGX_LOG_NOTICE
, 
r
->
c⁄√˘i⁄
->
log
, 0,

665 "tmdÜimôögÑeque°s, f‹bid_a˘i⁄ i†%V", 
a˘i⁄
);

667 (Ë
	`ngx_hâp_«med_loˇti⁄
(
r
, 
a˘i⁄
);

668 
	`ngx_hâp_föÆize_ªque°
(
r
, 
NGX_DONE
);

670  
NGX_DONE
;

672 } i‡(
a˘i⁄
->
d©a
[0] == '/') {

674 (Ë
	`ngx_hâp_öã∫Æ_ªdúe˘
(
r
, 
a˘i⁄
, 
NULL
);

675 
	`ngx_hâp_föÆize_ªque°
(
r
, 
NGX_DONE
);

677  
NGX_DONE
;

680  
NGX_DECLINED
;

681 
	}
}

684 
ngx_öt_t


685 
	$ngx_hâp_tmd_∑r£_hódîö
(
ngx_hâp_ªque°_t
 *
r
, 
ngx_°r_t
 *
hódî_«me
,

686 
ngx_°r_t
 *
vÆue
)

688 
ngx_uöt_t
 
i
;

689 
ngx_li°_∑π_t
 *
∑π
;

690 
ngx_èbÀ_ñt_t
 *
hódî
;

692 
∑π
 = &
r
->
hódîs_ö
.
hódîs
.part;

693 
hódî
 = 
∑π
->
ñts
;

695 
i
 = 0; ; i++) {

697 i‡(
i
 >
∑π
->
√…s
) {

698 i‡(
∑π
->
√xt
 =
NULL
) {

702 
∑π
 =Ö¨t->
√xt
;

703 
hódî
 = 
∑π
->
ñts
;

704 
i
 = 0;

707 i‡(
hódî
[
i
].
hash
 == 0) {

711 i‡(
hódî_«me
->
Àn
 =
hódî
[
i
].
key
.len

712 && 
	`ngx_°∫cmp
(
hódî
[
i
].
key
.
d©a
, 
hódî_«me
->data,

713 
hódî_«me
->
Àn
) == 0)

715 *
vÆue
 = 
hódî
[
i
].value;

716  
NGX_OK
;

720  
NGX_DECLINED
;

721 
	}
}

724 
ngx_ölöe
 
ngx_öt_t


725 
	$ngx_hâp_tmd_ªmŸe_addr
(
ngx_hâp_ªque°_t
 *
r
, 
ngx_°r_t
 *
ªmŸe_addr
,

726 
ngx_öt_t
 
mode
)

728 
ngx_hâp_tmd_loc_c⁄f_t
 *
écf
;

730 
écf
 = 
	`ngx_hâp_gë_moduÀ_loc_c⁄f
(
r
, 
ngx_hâp_tmd_moduÀ
);

732 i‡(
mode
 & 
NGX_TMD_SHM_MOD_PROXYIP
) {

733 i‡(
	`ngx_hâp_tmd_∑r£_hódîö
(
r
, &
écf
->
˛õ¡_ù_hódî
, 
ªmŸe_addr
)

734 =
NGX_OK
)

736 
	`ngx_log_îr‹
(
NGX_LOG_ERR
, 
r
->
c⁄√˘i⁄
->
log
, 0,

738 &
écf
->
˛õ¡_ù_hódî
, 
ªmŸe_addr
);

739  
NGX_OK
;

741  
NGX_DECLINED
;

745 #i‡
NGX_DEBUG


747 i‡(
	`ngx_hâp_¨g
(
r
, (
u_ch¨
 *Ë"sù", 3, 
ªmŸe_addr
Ë=
NGX_OK
) {

748 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
r
->
c⁄√˘i⁄
->
log
, 0,

749 "tmdÑemŸe(sùËaddr(%V)", 
ªmŸe_addr
);

750  
NGX_OK
;

754  
NGX_DECLINED
;

756 *
ªmŸe_addr
 = 
r
->
c⁄√˘i⁄
->
addr_ãxt
;

760  
NGX_OK
;

761 
	}
}

764 
ngx_öt_t


765 
	$ngx_hâp_tmd_cidr_vÆue
(
ngx_°r_t
 *
ù
, 
ngx_cidr_t
 *
cidr
,

766 
ngx_log_t
 *
log
)

768 
ngx_öt_t
 
rc
;

770 
rc
 = 
	`ngx_±ocidr
(
ù
, 
cidr
);

772 i‡(
rc
 =
NGX_ERROR
) {

773 
	`ngx_log_îr‹
(
NGX_LOG_ERR
, 
log
, 0, "tmd invÆidÇëw‹k %V", 
ù
);

774  
NGX_ERROR
;

777 i‡(
cidr
->
Ámûy
 !
AF_INET
) {

778 
	`ngx_log_îr‹
(
NGX_LOG_ERR
, 
log
, 0,

780  
NGX_ERROR
;

783 i‡(
rc
 =
NGX_DONE
) {

784 
	`ngx_log_îr‹
(
NGX_LOG_WARN
, 
log
, 0,

786 
ù
);

789 
cidr
->
u
.
ö
.
addr
 = 
	`¡ohl
(cidr->u.in.addr);

790 
cidr
->
u
.
ö
.
mask
 = 
	`¡ohl
(cidr->u.in.mask);

792  
NGX_OK
;

793 
	}
}

796 
ngx_öt_t


797 
	$ngx_hâp_tmd_check_ac˚ss_∑ges
(
ngx_hâp_ªque°_t
 *
r
)

799 
size_t
 
roŸ
;

800 
u_ch¨
 *
œ°
;

801 
ngx_°r_t
 
∑th
;

802 
ngx_öt_t
 
∑ge_Àn
, 
n
;

803 
ngx_uöt_t
 
i
;

804 
ngx_ªgex_t
 *
ªgex
;

805 
ngx_tmd_shm_˘x_t
 *
sh
;

806 
ngx_hâp_tmd_maö_c⁄f_t
 *
tmcf
;

808 
œ°
 = 
	`ngx_hâp_m≠_uri_to_∑th
(
r
, &
∑th
, &
roŸ
, 0);

809 i‡(
œ°
 =
NULL
) {

810  
NGX_HTTP_NOT_FOUND
;;

813 
tmcf
 = 
	`ngx_hâp_gë_moduÀ_maö_c⁄f
(
r
, 
ngx_hâp_tmd_moduÀ
);

815 
sh
 = 
tmcf
->
tmd_˘x
->sh;

817 
∑th
.
Àn
 = 
œ°
 -Ö©h.
d©a
;

819 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_HTTP
, 
r
->
c⁄√˘i⁄
->
log
, 0,

820 "tmd hâ∞roŸ: \"%V\"", &
∑th
);

822 i‡(
sh
->
ac˚ss_∑ges_cou¡
 == 0) {

823 
	`ngx_log_îr‹
(
NGX_LOG_DEBUG
, 
r
->
c⁄√˘i⁄
->
log
, 0,

825  
NGX_DECLINED
;

828 
i
 = 0; i < 
sh
->
ac˚ss_∑ges_cou¡
; i++) {

829 
∑ge_Àn
 = 
	`ngx_°æí
((*Ë
sh
->
ac˚ss_∑ges
[
i
]);

830 if(
∑ge_Àn
 > 
NGX_HTTP_TMD_MAX_RESOURCE
) {

834 #i‡(
NGX_PCRE
)

836 
u_ch¨
 
îr°r
[
NGX_MAX_CONF_ERRSTR
];

837 
ngx_ªgex_compûe_t
 
rc
;

838 
	`ngx_memzîo
(&
rc
, (
ngx_ªgex_compûe_t
));

839 
rc
.
poﬁ
 = 
r
->pool;

840 
rc
.
îr
.
Àn
 = 
NGX_MAX_CONF_ERRSTR
;

841 
rc
.
îr
.
d©a
 = 
îr°r
;

842 
rc
.
›ti⁄s
 = 
NGX_REGEX_CASELESS
;

843 
rc
.
∑âîn
.
d©a
 = (
u_ch¨
 *Ë
sh
->
ac˚ss_∑ges
[
i
];

844 
rc
.
∑âîn
.
Àn
 = 
∑ge_Àn
;

845 i‡(
	`ngx_ªgex_compûe
(&
rc
Ë!
NGX_OK
) {

846 
	`ngx_log_îr‹
(
NGX_LOG_EMERG
, 
r
->
c⁄√˘i⁄
->
log
, 0, "%V", &
rc
.
îr
);

849 
ªgex
 = 
rc
.regex;

851 
n
 = 
	`ngx_ªgex_exec
(
ªgex
, &
∑th
, 
NULL
,0);

853 i‡(
n
 =
NGX_REGEX_NO_MATCHED
) {

857 i‡(
n
 < 0) {

858 
	`ngx_log_îr‹
(
NGX_LOG_ALERT
, 
r
->
c⁄√˘i⁄
->
log
, 0,

859 
ngx_ªgex_exec_n
 " failed: %i on \"%V\" using \"%s\"",

860 
n
, &
r
->
uri
, &
sh
->
ac˚ss_∑ges
[
i
]);

866  
NGX_OK
;

870  
NGX_DECLINED
;

871 
	}
}

874 
ngx_öt_t


875 
	$ngx_hâp_tmd_dod
(
ngx_hâp_ªque°_t
 *
r
, 
ngx_öt_t
 
mode
)

877 
ngx_hâp_tmd_maö_c⁄f_t
 *
tmcf
;

878 
ngx_hâp_tmd_loc_c⁄f_t
 *
écf
;

879 
ngx_öt_t
 
rc
, 
whôñi°
;

880 
ngx_uöt_t
 
mósuª
;

881 
ngx_tmd_shm_˘x_t
 *
sh
;

882 
ngx_hâp_tmd_ªq_˘x_t
 *
˘x
;

883 
ngx_°r_t
 
ªmŸe_addr
;

884 
ngx_cidr_t
 
cidr
;

885 
ngx_°r_t
 **
cookõs
;

886 
uöt16_t
 
cookõ_Àn
;

889 
tmcf
 = 
	`ngx_hâp_gë_moduÀ_maö_c⁄f
(
r
, 
ngx_hâp_tmd_moduÀ
);

890 
écf
 = 
	`ngx_hâp_gë_moduÀ_loc_c⁄f
(
r
, 
ngx_hâp_tmd_moduÀ
);

891 
sh
 = 
tmcf
->
tmd_˘x
->sh;

894 i‡(
sh
->
öô_°©e
 !
NGX_TMD_SHM_INIT_STATE_OK
) {

895 
	`ngx_log_îr‹
(
NGX_LOG_NOTICE
, 
r
->
c⁄√˘i⁄
->
log
, 0,

897  
NGX_DECLINED
;

900 
rc
 = 
	`ngx_hâp_tmd_check_ac˚ss_∑ges
(
r
);

902 i‡(
rc
 !
NGX_OK
) {

903 
	`ngx_log_îr‹
(
NGX_LOG_NOTICE
, 
r
->
c⁄√˘i⁄
->
log
, 0,

905  
rc
;

908 
mósuª
 = 0;

909 
whôñi°
 = 0;

911 
rc
 = 
	`ngx_hâp_tmd_ªmŸe_addr
(
r
, &
ªmŸe_addr
, 
mode
);

913 i‡(
rc
 !
NGX_OK
) {

914 
	`ngx_log_îr‹
(
NGX_LOG_NOTICE
, 
r
->
c⁄√˘i⁄
->
log
, 0,

916  
NGX_DECLINED
;

919 
rc
 = 
	`ngx_hâp_tmd_cidr_vÆue
(&
ªmŸe_addr
, &
cidr
, 
r
->
c⁄√˘i⁄
->
log
);

921 i‡(
rc
 !
NGX_OK
) {

922 
	`ngx_log_îr‹
(
NGX_LOG_NOTICE
, 
r
->
c⁄√˘i⁄
->
log
, 0,

924  
NGX_DECLINED
;

927 
˘x
 = 
	`ngx_hâp_gë_moduÀ_˘x
(
r
, 
ngx_hâp_tmd_moduÀ
);

929 i‡(
˘x
 =
NULL
) {

930  
NGX_DECLINED
;

933 
˘x
->
addr_ãxt
 = 
ªmŸe_addr
;

934 
˘x
->
cidr
 = cidr.
u
.
ö
;

936 
rc
 = 
	`ngx_hâp_tmd_check_°©ic_whôñi°
(
r
, 
écf
);

937 i‡(
rc
 !
NGX_OK
) {

938  
rc
;

941 
rc
 = 
	`ngx_hâp_tmd_ù_punish
(
r
,&
mósuª
);

943 i‡(
rc
 =
NGX_DECLINED
) {

944 
whôñi°
 = 1;

948 
cookõs
 = 
	`ngx_∑Œoc
(
r
->
poﬁ
,

949 
NGX_TMD_SHM_COOKIE_MAX
 * (
ngx_°r_t
 *));

951 i‡(
cookõs
 =
NULL
) {

952  
NGX_ERROR
;

955 i‡((
cookõ_Àn
 = 
	`ngx_hâp_tmd_comböe_cookõ
(
r
, 
cookõs
, &
mósuª
)) == 0) {

956  
NGX_ERROR
;

959 
	`ngx_log_îr‹
(
NGX_LOG_NOTICE
, 
r
->
c⁄√˘i⁄
->
log
, 0,

961 
mósuª
, 
cookõ_Àn
);

963 i‡(
whôñi°
) {

964 
	`ngx_log_îr‹
(
NGX_LOG_NOTICE
, 
r
->
c⁄√˘i⁄
->
log
, 0,

965 "tmd uæ: [%V] i† whôñi°", &
r
->
uri
);

966 i‡(
sh
->
£nd_whôe_evít
) {

967 (Ë
	`ngx_hâp_tmdagít_ªque°
(
r
, 
cookõs
, 
cookõ_Àn
,

968 
mósuª
, &
ªmŸe_addr
);

969  
NGX_DECLINED
;

971  
NGX_DECLINED
;

974 i‡(
mósuª
 != 0) {

975 i‡(
sh
->
£nd_bœck_evít
) {

976 (Ë
	`ngx_hâp_tmdagít_ªque°
(
r
, 
cookõs
, 
cookõ_Àn
,

977 
mósuª
, &
ªmŸe_addr
);

979 i‡(
sh
->
is_punish
 == 0) {

980 
	`ngx_log_îr‹
(
NGX_LOG_NOTICE
, 
r
->
c⁄√˘i⁄
->
log
, 0,

982  
NGX_DECLINED
;

984  
mósuª
;

987 (Ë
	`ngx_hâp_tmdagít_ªque°
(
r
, 
cookõs
, 
cookõ_Àn
,

988 
mósuª
, &
ªmŸe_addr
);

989  
NGX_DECLINED
;

990 
	}
}

993 
ngx_öt_t


994 
	$ngx_hâp_tmd_ù_punish
(
ngx_hâp_ªque°_t
 *
r
, 
ngx_uöt_t
 *
mósuª
)

996 
ngx_hâp_tmd_ªq_˘x_t
 *
˘x
;

997 
ngx_tmd_ù_node_t
 *
node
;

998 
ngx_hâp_tmd_˘x_t
 *
t˘x
;

999 
ngx_hâp_tmd_maö_c⁄f_t
 *
tmcf
;

1001 
˘x
 = 
	`ngx_hâp_gë_moduÀ_˘x
(
r
, 
ngx_hâp_tmd_moduÀ
);

1002 
tmcf
 = 
	`ngx_hâp_gë_moduÀ_maö_c⁄f
(
r
, 
ngx_hâp_tmd_moduÀ
);

1003 
t˘x
 = 
tmcf
->
tmd_˘x
;

1005 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
r
->
c⁄√˘i⁄
->
log
, 0,

1007 &
˘x
->
addr_ãxt
, (
ngx_öt_t
)˘x->
cidr
.
addr
);

1009 i‡(
	`±hªad_rwlock_rdlock
(&
t˘x
->
sh
->
rwlock
) != 0) {

1010  
NGX_DECLINED
;

1013 
node
 = 
	`ngx_shm_ødix32åì_föd
(
t˘x
->
sh
->
åì
, 
˘x
->
cidr
.
addr
);

1015 i‡(
node
 =
NULL
) {

1016 
	`±hªad_rwlock_u∆ock
(&
t˘x
->
sh
->
rwlock
);

1017  
NGX_DECLINED
;

1020 i‡(
node
->
mósuª
 =
NGX_TMD_SHM_MEASURE_WHITE_FLAG
) {

1021 
	`±hªad_rwlock_u∆ock
(&
t˘x
->
sh
->
rwlock
);

1022  
NGX_DECLINED
;

1025 i‡(
node
->
expúe_time
 > (
ngx_uöt_t
Ë
r
->
°¨t_£c
) {

1026 *
mósuª
 = 
node
->measure;

1029 
	`±hªad_rwlock_u∆ock
(&
t˘x
->
sh
->
rwlock
);

1031  
NGX_OK
;

1032 
	}
}

1035 
ngx_öt_t


1036 
	$ngx_hâp_tmd_c⁄åﬁ_h™dÀr
(
ngx_hâp_ªque°_t
 *
r
)

1038 i‡(
	`ngx_hâp_tmd_check_íabÀ
(
r
Ë!
NGX_OK
) {

1039  
NGX_DECLINED
;

1042  
NGX_DECLINED
;

1043 
	}
}

1046 
ngx_öt_t


1047 
	$ngx_hâp_tmd_öô_¥o˚ss
(
ngx_cy˛e_t
 *
cy˛e
)

1049 
ngx_hâp_tmd_maö_c⁄f_t
 *
tmcf
;

1050 
ngx_öt_t
 
n
;

1051 
ngx_hâp_tmd_˘x_t
 *
t˘x
;

1053 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
cy˛e
->
log
, 0,"tmd initÖrocess\n");

1055 
tmcf
 = 
	`ngx_hâp_cy˛e_gë_moduÀ_maö_c⁄f
(
cy˛e
, 
ngx_hâp_tmd_moduÀ
);

1057 i‡(
tmcf
->
íabÀ
 == 0) {

1058  
NGX_DECLINED
;

1061 
t˘x
 = 
	`ngx_pˇŒoc
(
cy˛e
->
poﬁ
, (
ngx_hâp_tmd_˘x_t
));

1063 i‡(
t˘x
 =
NULL
) {

1064 
	`ngx_log_îr‹
(
NGX_LOG_ERR
, 
cy˛e
->
log
, 0,

1066  
NGX_ERROR
;

1069 
tmcf
->
tmd_˘x
 = 
t˘x
;

1071 
n
 = 0;Ç < 
ngx_œ°_¥o˚ss
;Ç++) {

1073 i‡(
ngx_¥o˚s£s
[
n
].
pid
 == -1) {

1077 i‡(
n
 =
ngx_¥o˚ss_¶Ÿ
) {

1081 i‡(
ngx_tmd_sockë∑ús
[
n
][1] == 0) {

1085 i‡(
	`˛o£
(
ngx_tmd_sockë∑ús
[
n
][0]) == -1) {

1086 
	`ngx_log_îr‹
(
NGX_LOG_ALERT
, 
cy˛e
->
log
, 
ngx_î∫o
,

1089 i‡(
	`˛o£
(
ngx_tmd_sockë∑ús
[
n
][1]) == -1) {

1090 
	`ngx_log_îr‹
(
NGX_LOG_ALERT
, 
cy˛e
->
log
, 
ngx_î∫o
,

1095 i‡(
	`˛o£
(
ngx_tmd_sockë∑ús
[
ngx_¥o˚ss_¶Ÿ
][0]) == -1) {

1096 
	`ngx_log_îr‹
(
NGX_LOG_ALERT
, 
cy˛e
->
log
, 
ngx_î∫o
,

1100 i‡(
	`ngx_tmd_add_ch™√l_evít
(
cy˛e
,

1101 
ngx_tmd_sockë∑ús
[
ngx_¥o˚ss_¶Ÿ
][1],

1102 
NGX_READ_EVENT
, 
ngx_hâp_tmd_ªad_h™dÀr
,

1103 
t˘x
)

1104 =
NGX_ERROR
)

1106 
	`ngx_log_îr‹
(
NGX_LOG_ERR
, 
cy˛e
->
log
, 
ngx_î∫o
,

1109  
NGX_ERROR
;

1112  
NGX_OK
;

1113 
	}
}

1117 
	$ngx_hâp_tmd_ªad_h™dÀr
(
ngx_evít_t
 *
ªv
)

1119 
ngx_öt_t
 
n
;

1120 
ngx_ch™√l_t
 
ch
;

1121 
ngx_c⁄√˘i⁄_t
 *
c
;

1122 
ngx_hâp_tmd_˘x_t
 *
t˘x
;

1124 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
ªv
->
log
, 0,

1127 i‡(
ªv
->
timedout
) {

1128 
ªv
->
timedout
 = 0;

1132 
c
 = 
ªv
->
d©a
;

1133 
t˘x
 = 
c
->
d©a
;

1134 
t˘x
->
c⁄√˘i⁄
 = 
c
;

1138 
n
 = 
	`ngx_ªad_ch™√l
(
c
->
fd
, &
ch
, (
ngx_ch™√l_t
), 
ªv
->
log
);

1140 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
ªv
->
log
, 0, "tmd ch™√l: %i", 
n
);

1142 i‡(
n
 =
NGX_ERROR
) {

1144 i‡(
ngx_evít_Êags
 & 
NGX_USE_EPOLL_EVENT
) {

1145 
	`ngx_dñ_c⁄n
(
c
, 0);

1148 
	`ngx_˛o£_c⁄√˘i⁄
(
c
);

1152 i‡(
n
 =
NGX_AGAIN
) {

1156 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
ªv
->
log
, 0,

1157 "tmd ch™√»comm™d: %d", 
ch
.
comm™d
);

1159 
ch
.
comm™d
) {

1161 
NGX_CMD_OPEN_CHANNEL
:

1163 
	`ngx_log_debug3
(
NGX_LOG_DEBUG_HTTP
, 
ªv
->
log
, 0,

1165 
ch
.
¶Ÿ
, ch.
pid
, ch.
fd
);

1166 
	`ngx_hâp_tmd_öô_shm_z⁄e
(
t˘x
);

1172 
	}
}

1176 
	$ngx_hâp_tmd_£t_shm
(
ngx_c⁄f_t
 *
cf
, 
ngx_comm™d_t
 *
cmd
, *
c⁄f
)

1178 
ngx_hâp_tmd_maö_c⁄f_t
 *
tmcf
;

1179 
ngx_°r_t
 *
vÆue
;

1180 
size_t
 
size
;

1181 
ngx_shm_z⁄e_t
 *
shm_z⁄e
;

1183 
tmcf
 = 
c⁄f
;

1184 
vÆue
 = 
cf
->
¨gs
->
ñts
;

1186 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
cf
->
log
, 0, "tmd set shm");

1188 i‡(
	`ngx_°∫cmp
("size", 
vÆue
[2].
d©a
, 4) != 0) {

1189 
	`ngx_c⁄f_log_îr‹
(
NGX_LOG_EMERG
, 
cf
, 0,"tmd size invalide");

1190  
NGX_CONF_ERROR
;

1193 
size
 = 
	`ngx_∑r£_size
(&
vÆue
[3]);

1195 
shm_z⁄e
 = 
	`ngx_sh¨ed_mem‹y_add
(
cf
, &
vÆue
[1], 0, (*Ë
size
);

1197 i‡(
shm_z⁄e
 =
NULL
) {

1198 
	`ngx_c⁄f_log_îr‹
(
NGX_LOG_EMERG
, 
cf
, 0,

1200  
NGX_CONF_ERROR
;

1203 
tmcf
->
shm_z⁄e
 = shm_zone;

1205  
NGX_CONF_OK
;

1206 
	}
}

1209 
ngx_öt_t


1210 
	$ngx_hâp_tmd_öô_shm_z⁄e
(
ngx_hâp_tmd_˘x_t
 *
t˘x
)

1212 
ngx_hâp_tmd_maö_c⁄f_t
 *
tmcf
;

1213 
ngx_shm_z⁄e_t
 *
shm_z⁄e
;

1215 
tmcf
 = 
	`ngx_hâp_cy˛e_gë_moduÀ_maö_c⁄f
(
ngx_cy˛e
, 
ngx_hâp_tmd_moduÀ
);

1216 
shm_z⁄e
 = 
tmcf
->shm_zone;

1218 
t˘x
->
shpoﬁ
 = (
ngx_¶ab_poﬁ_t
 *Ë
shm_z⁄e
->
shm
.
addr
;

1220 
t˘x
->
sh
 =Å˘x->
shpoﬁ
->
d©a
;

1222  
NGX_OK
;

1223 
	}
}

1227 
	$ngx_hâp_tmd_exô_¥o˚ss
(
ngx_cy˛e_t
 *
cy˛e
)

1230 
	}
}

1233 
ngx_öt_t


1234 
	$ngx_hâp_tmdagít_ªque°
(
ngx_hâp_ªque°_t
 *
r
, 
ngx_°r_t
 **
cookõs
,

1235 
uöt16_t
 
cookõ_Àn
, 
ngx_öt_t
 
mósuª
, 
ngx_°r_t
 *
ªmŸe_addr
)

1237 
ngx_hâp_tmd_maö_c⁄f_t
 *
tmcf
;

1238 
ngx_tmd_shm_˘x_t
 *
sh
;

1239 
ngx_öt_t
 
block_size
, 
i
, 
£nd_size
, 
uri_Àn
;

1240 
u_öt16_t
 
Àn
;

1241 
ngx_tmdagít_block_t
 *
agít_block
;

1242 
u_ch¨
 *
p
, *
uri
, *
uri_p
;

1243 
ck
;

1244 
ngx_hâp_tmd_ªq_˘x_t
 *
˘x
;

1245 
ngx_c⁄√˘i⁄_t
 *
c
;

1248 
tmcf
 = 
	`ngx_hâp_gë_moduÀ_maö_c⁄f
(
r
, 
ngx_hâp_tmd_moduÀ
);

1249 
sh
 = 
tmcf
->
tmd_˘x
->sh;

1250 
˘x
 = 
	`ngx_hâp_gë_moduÀ_˘x
(
r
, 
ngx_hâp_tmd_moduÀ
);

1251 
c
 = 
tmcf
->
tmd_˘x
->
c⁄√˘i⁄
;

1253 
uri_Àn
 = 
r
->
hódîs_ö
.
£rvî
.
Àn


1254 + 
r
->
uri
.
Àn
 + 
NGX_CHANNEL_TMD_SCHEME_LEN
;

1255 i‡(
uri_Àn
 > 
NGX_CHANNEL_TMD_MAX_URI_LEN
) {

1256 
uri_Àn
 = 
NGX_CHANNEL_TMD_MAX_URI_LEN
;

1259 
Àn
 = 0;

1261 
block_size
 = 
cookõ_Àn
 + 
uri_Àn


1262 + (
u_öt16_t
Ë* (
NGX_TMD_SHM_COOKIE_MAX
 + 1);

1263 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
r
->
c⁄√˘i⁄
->
log
, 0,

1265 
agít_block
 = 
	`ngx_pˇŒoc
(
r
->
poﬁ
, (
ngx_tmdagít_block_t
)

1266 + 
block_size
);

1268 i‡(
agít_block
 =
NULL
) {

1269  
NGX_ERROR
;

1272 i‡(
mósuª
 != 0) {

1273 
agít_block
->
a˘i⁄
 = 
NGX_CHANNEL_TMD_DOD_BEVENT_SEND
;

1275 
agít_block
->
a˘i⁄
 = 
NGX_CHANNEL_TMD_DOD_EVENT_SEND
;

1279 
agít_block
->
ªmŸe_ù
 = 
˘x
->
cidr
.
addr
;

1280 
agít_block
->
f‹w¨d_ù
 = 0;

1282 
agít_block
->
visô_time
 = 
	`ht⁄l
(
r
->
°¨t_£c
);

1283 
agít_block
->
cookõ_Àn
 = 
	`ht⁄s
(cookie_len);

1285 
p
 = 
agít_block
->
d©a
;

1287 
i
 = 0; i< 
NGX_TMD_SHM_COOKIE_MAX
; i++) {

1288 
ck
 = 
sh
->
cookõs
[
i
][0];

1290 i‡(
ck
) {

1291 *
p
++ = 
ck
;

1293 
Àn
 = 
cookõs
[
i
] =
NULL
 ? (
u_öt16_t
) 0

1294 : 
	`ht⁄s
((
u_öt16_t
Ë
cookõs
[
i
]->
Àn
);

1296 
p
 = 
	`ngx_˝ymem
’, &
Àn
, (
uöt16_t
));

1298 i‡(
Àn
) {

1299 
p
 = 
	`ngx_˝ymem
’, 
cookõs
[
i
]->
d©a
, cookõs[i]->
Àn
);

1304 
uri
 = 
	`ngx_pˇŒoc
(
r
->
poﬁ
, 
uri_Àn
);

1306 i‡(
uri
 =
NULL
) {

1307 
	`ngx_log_îr‹
(
NGX_LOG_ERR
, 
r
->
c⁄√˘i⁄
->
log
, 0,

1308 "tmdÖˇŒo¯uæÉº‹ ,√ed [%d] byãs", 
uri_Àn
);

1309  
NGX_ERROR
;

1312 
uri_p
 = 
	`ngx_¢¥ötf
(
uri
, 
uri_Àn
, "%V%V", &
r
->
hódîs_ö
.
£rvî
, &r->uri);

1313 
uri_Àn
 = 
uri_p
 - 
uri
 + 1;

1314 
uri_Àn
 = 
	`ht⁄s
(uri_len);

1316 
p
 = 
	`ngx_˝ymem
’, &
uri_Àn
, (
u_öt16_t
));

1317 
p
 = 
	`ngx_˝ymem
’, 
uri
, (
u_öt16_t
)(
uri_p
 - uri) + 1);

1319 
£nd_size
 = 
p
 - 
agít_block
->
d©a
 + (
ngx_tmdagít_block_t
);

1321 
agít_block
->
Àngth
 = 
£nd_size
 - 
NGX_CHANNEL_TMD_AGENT_HEADER_LENGTH
;

1323 #i‡
NGX_DEBUG


1325 
	`ngx_log_îr‹
(
NGX_LOG_DEBUG
, 
r
->
c⁄√˘i⁄
->
log
, 
î∫o
,

1329 (
ngx_öt_t
Ë
agít_block
->
vîsi⁄
,

1330 (
ngx_öt_t
Ë
agít_block
->
a˘i⁄
,

1331 (
ngx_öt_t
Ë
agít_block
->
Àngth
,

1332 
ªmŸe_addr
,

1333 (
ngx_öt_t
Ë
agít_block
->
ªmŸe_ù
,

1334 (
ngx_öt_t
Ë
	`¡ohl
(
agít_block
->
visô_time
),

1335 (
ngx_öt_t
Ë
	`¡ohs
(
agít_block
->
cookõ_Àn
));

1339 i‡(
	`ngx_£nd
(
c
, (
u_ch¨
 *Ë
agít_block
, 
£nd_size
) != send_size) {

1340 
	`ngx_log_îr‹
(
NGX_LOG_NOTICE
, 
r
->
c⁄√˘i⁄
->
log
, 
î∫o
,

1341 "tmd síd faûed sizêi†[%i]", 
agít_block
->
Àngth
);

1344 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
r
->
c⁄√˘i⁄
->
log
, 0,

1345 "tmd, sídÅÿdod clõ¡ havêíd: %i", 
£nd_size
);

1347  
NGX_OK
;

1348 
	}
}

1351 
uöt16_t


1352 
	$ngx_hâp_tmd_comböe_cookõ
(
ngx_hâp_ªque°_t
 *
r
, 
ngx_°r_t
 **
cookõs
,

1353 
ngx_uöt_t
 *
mósuª
)

1355 
uöt16_t
 
cookõ_Àn
;

1356 
ngx_öt_t
 
i
, 
n
;

1357 
ngx_hâp_tmd_maö_c⁄f_t
 *
tmcf
;

1358 
ngx_tmd_shm_˘x_t
 *
sh
;

1359 
ngx_°r_t
 
cookõ_«me
, *
cookõ_vÆue
;

1361 
cookõ_Àn
 = 0;

1363 
tmcf
 = 
	`ngx_hâp_gë_moduÀ_maö_c⁄f
(
r
, 
ngx_hâp_tmd_moduÀ
);

1364 
sh
 = 
tmcf
->
tmd_˘x
->sh;

1366 
i
 = 0; i< 
NGX_TMD_SHM_COOKIE_MAX
; i++) {

1367 i‡(
sh
->
cookõs
[
i
][0] == '\0') {

1368 
cookõs
[
i
] = 
NULL
;

1373 
cookõ_«me
.
d©a
 = 
sh
->
cookõs
[
i
] + 1;

1375 
cookõ_«me
.
Àn
 = 
	`ngx_°æí
(
sh
->
cookõs
[
i
] + 1);

1377 
	`ngx_log_îr‹
(
NGX_LOG_INFO
, 
r
->
c⁄√˘i⁄
->
log
, 0,

1378 "tmd cookõ_«mêi† [%V]", &
cookõ_«me
);

1380 
cookõ_vÆue
 = 
	`ngx_∑Œoc
(
r
->
poﬁ
, (
ngx_°r_t
));

1381 i‡(
cookõ_vÆue
 =
NULL
) {

1385 
n
 = 
	`ngx_hâp_∑r£_mu…i_hódî_löes
(&
r
->
hódîs_ö
.
cookõs
,

1386 &
cookõ_«me
, 
cookõ_vÆue
);

1388 i‡(
n
 =
NGX_DECLINED
) {

1389 
cookõs
[
i
] = 
NULL
;

1390 
cookõ_Àn
 += 3;

1394 
cookõs
[
i
] = 
cookõ_vÆue
;

1395 
cookõ_Àn
 +(
u_öt16_t
Ë(3 + 
cookõ_vÆue
->
Àn
);

1397 
	`ngx_log_îr‹
(
NGX_LOG_INFO
, 
r
->
c⁄√˘i⁄
->
log
, 0,

1398 "tmd cookõ_vÆuêi† [%V]", 
cookõ_vÆue
);

1403  
cookõ_Àn
;

1404 
	}
}

	@
1
.
1
/usr/include
1
22
ngx_http_tmd_module.c
